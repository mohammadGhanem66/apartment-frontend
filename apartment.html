<!DOCTYPE html>
<html lang="en" dir="rtl" class="rtl">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Twitter -->
    <meta name="twitter:site" content="@themepixels">
    <meta name="twitter:creator" content="@themepixels">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bracket Plus">
    <meta name="twitter:description" content="Premium Quality and Responsive UI for Dashboard.">
    <meta name="twitter:image" content="http://themepixels.me/bracketplus/img/bracketplus-social.png">

    <!-- Facebook -->
    <meta property="og:url" content="http://themepixels.me/bracketplus">
    <meta property="og:title" content="Bracket Plus">
    <meta property="og:description" content="Premium Quality and Responsive UI for Dashboard.">

    <meta property="og:image" content="http://themepixels.me/bracketplus/img/bracketplus-social.png">
    <meta property="og:image:secure_url" content="http://themepixels.me/bracketplus/img/bracketplus-social.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="600">

    <!-- Meta -->
    <meta name="description" content="Premium Quality and Responsive UI for Dashboard.">
    <meta name="author" content="ThemePixels">

    <title>Dashboard Cards | Apartment </title>

    <!-- vendor css -->
    <link href="lib/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="lib/ionicons/css/ionicons.min.css" rel="stylesheet">
    <link href="lib/rickshaw/rickshaw.min.css" rel="stylesheet">

    <!-- Bracket CSS -->
    <link rel="stylesheet" href="css/bracket.css">
    <style>
.card {
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

table {
    width: 100%; /* Makes the table span the full width */
    border-collapse: collapse;
}

thead th {
    background-color: #f5f5f5; /* Light background for headers */
    text-align: left;
    padding: 10px;
    border-bottom: 2px solid #ddd; /* Separate header visually */
}

tbody td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: left; /* Aligns all text consistently */
}

.card-footer {
    text-align: right; /* Align footer elements to the right */
}

.collapse .form-layout {
    background: #f9f9f9; /* Light background for forms */
    padding: 15px;
    border-radius: 5px;
}

    </style>
  </head>

  <body>

    <!-- ########## START: LEFT PANEL ########## -->
    <div class="br-logo"><a href=""><span>[</span>bracket <i>plus</i><span>]</span></a></div>
  <div class="br-sideleft sideleft-scrollbar">
      <label class="sidebar-label pd-x-10 mg-t-20 op-3">القائمة</label>
      <ul class="br-sideleft-menu">
        <li class="br-menu-item">
          <a href="index.html" class="br-menu-link ">
            <i class="menu-item-icon icon ion-ios-home-outline tx-24"></i>
            <span class="menu-item-label">الرئيسية</span>
          </a><!-- br-menu-link -->
        </li><!-- br-menu-item -->

       
    
        <li class="br-menu-item">
          <a href="#" class="br-menu-link with-sub active">
            <i class="menu-item-icon ion-ios-redo-outline tx-24"></i>
            <span class="menu-item-label">العمارات</span>
          </a><!-- br-menu-link -->
          <ul class="br-menu-sub">
            <li class="sub-item"><a href="building.html" class="sub-link active">العمارات</a></li>
            <li class="sub-item"><a href="apartment-create.html" class="sub-link">انشاء عمارة</a></li>
            <li class="sub-item"><a href="#" class="sub-link">التعديل على عمارة</a></li>
          </ul>
        </li><!-- br-menu-item -->
        <li class="br-menu-item">
          <a href="#" id="installLink">Install App</a>
        </li><!-- br-menu-item -->

      </ul><!-- br-sideleft-menu -->

    </div><!-- br-sideleft -->
    <!-- ########## END: LEFT PANEL ########## -->

    <!-- ########## START: HEAD PANEL ########## -->
    <div class="br-header">
      <div class="br-header-left">
        <div class="navicon-left hidden-md-down"><a id="btnLeftMenu" href=""><i class="icon ion-navicon-round"></i></a></div>
        <div class="navicon-left hidden-lg-up"><a id="btnLeftMenuMobile" href=""><i class="icon ion-navicon-round"></i></a></div>

      </div><!-- br-header-left -->
      <div class="br-header-right">
        <nav class="nav">
      
          <div class="dropdown">
            <a href="" class="nav-link pd-x-7 pos-relative" data-toggle="dropdown">
              <i class="icon ion-ios-bell-outline tx-24"></i>
              <!-- start: if statement -->
              <span class="square-8 bg-danger pos-absolute t-15 r-5 rounded-circle"></span>
              <!-- end: if statement -->
            </a>
            <div class="dropdown-menu dropdown-menu-header">
              <div class="dropdown-menu-label">
                <label>الاشعارات</label>
              </div><!-- d-flex -->

              <div class="media-list">
                <!-- loop starts here -->
                <a href="" class="media-list-link read">
                  <div class="media">
                    <img src="https://via.placeholder.com/500" alt="">
                    <div class="media-body">
                      <p class="noti-text">دفعة 500 مستحقة من قبل محمد</p>
                      <span>October 03, 2017 8:45am</span>
                    </div>
                  </div><!-- media -->
                </a>
                <!-- loop ends here -->
                <a href="" class="media-list-link read">
                  <div class="media">
                    <img src="https://via.placeholder.com/500" alt="">
                    <div class="media-body">
                    <p class="noti-text">دفعة 500 مستحقة من قبل محمد</p>
                      <span>October 02, 2017 12:44am</span>
                    </div>
                  </div><!-- media -->
                </a>
                <a href="" class="media-list-link read">
                  <div class="media">
                    <img src="https://via.placeholder.com/500" alt="">
                    <div class="media-body">
                 <p class="noti-text">دفعة 500 مستحقة من قبل محمد</p>
                      <span>October 01, 2017 10:20pm</span>
                    </div>
                  </div><!-- media -->
                </a>
                <a href="" class="media-list-link read">
                  <div class="media">
                    <img src="https://via.placeholder.com/500" alt="">
                    <div class="media-body">
                   <p class="noti-text">دفعة 500 مستحقة من قبل محمد</p>
                      <span>October 01, 2017 6:08pm</span>
                    </div>
                  </div><!-- media -->
                </a>
      
              </div><!-- media-list -->
            </div><!-- dropdown-menu -->
          </div><!-- dropdown -->
          <div class="dropdown">
            <a href="" class="nav-link nav-link-profile" data-toggle="dropdown">
              <span class="logged-name hidden-md-down">مصعب</span>
              <img src="https://via.placeholder.com/500" class="wd-32 rounded-circle" alt="">
              <span class="square-10 bg-success"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-header wd-250">
              <div class="tx-center">
                <a href=""><img src="https://via.placeholder.com/500" class="wd-80 rounded-circle" alt=""></a>
                <h6 class="logged-fullname">مصعب</h6>

              </div>

              <ul class="list-unstyled user-profile-nav">
                <li><a href=""><i class="icon ion-power"></i> تسجيل الخروج</a></li>
              </ul>
            </div><!-- dropdown-menu -->
          </div><!-- dropdown -->
        </nav>
        <div class="navicon-right">
    
        </div><!-- navicon-right -->
		 <div class="navicon-right">
    
        </div><!-- navicon-right -->
      </div><!-- br-header-right -->
    </div><!-- br-header -->
    <!-- ########## END: HEAD PANEL ########## -->

    <!-- ########## START: RIGHT PANEL ########## -->
 
    <!-- ########## END: RIGHT PANEL ########## --->

    <!-- ########## START: MAIN PANEL ########## -->
    <div class="br-mainpanel">
 
      <div class="br-pagetitle">
        <i class="icon icon ion-ios-photos"></i>
        <div>
          <h4 id="Aname"></h4>
         </div>
      </div><!-- d-flex -->

      <div class="br-pagebody pd-x-20 pd-sm-x-30">
      
 

        <div class="row row-sm mg-t-20">
          <div class="col-sm-6 col-lg-4">
            <div class="card shadow-base bd-0">
              <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h6 class="card-title tx-uppercase tx-12 mg-b-0">وصف العمارة</h6>
                <span class="tx-12 tx-uppercase" id="Adescription"> </span>
              </div><!-- card-header -->
              <div class="card-body d-xs-flex justify-content-between align-items-center">
                <h5 class="mg-b-0 tx-inverse tx-lato tx-bold">عدد الغرف</h5>
                <p class="mg-b-0 tx-sm"><i class='fa fa-home tx-warning'></i> <span class="tx-warning"id ="AroomsCount"></span></p>
              </div><!-- card-body -->
            </div><!-- card -->
          </div><!-- col-4 -->
          <div class="col-sm-6 col-lg-4 mg-t-20 mg-sm-t-0">
            <div class="card shadow-base bd-0">
              <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h6 class="card-title tx-uppercase tx-12 mg-b-0">هل الشقة متاحة ؟</h6>
				<p class="mg-b-0 tx-sm"><i class="fa fa-bars tx-success"></i> <span class="tx-success" id="AisAvaliable"></span></p>
              </div><!-- card-header -->
              <div class="card-body d-xs-flex justify-content-between align-items-center">
                <h5 class="mg-b-0 tx-inverse tx-lato tx-bold"> قيمة الاجار الشهرية</h5>
				<p class="mg-b-0 tx-sm"><i class="fa fa-gem tx-danger" aria-hidden="true"></i> <span class="tx-danger" id="ArentingValuePerMonth"></span></p>
              </div><!-- card-body -->
            </div><!-- card -->
          </div><!-- col-4 -->
          <!-- <div class="col-sm-6 col-lg-4 mg-t-20 mg-lg-t-0">
            <div class="card shadow-base bd-0">
              <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h6 class="card-title tx-uppercase tx-12 mg-b-0">قيمة الخدمات الشهرية </h6>
                <p class="mg-b-0 tx-sm"><i class="fa fa-gem tx-danger" aria-hidden="true"></i> <span class="tx-danger" id="BtotalServices"> </span></p>
              </div>
              <div class="card-body d-xs-flex justify-content-between align-items-center">
                <h4 class="mg-b-0 tx-inverse tx-lato tx-bold"></h4>
                <p class="mg-b-0 tx-sm"></p>
              </div>
            </div> 
          </div>  -->
        </div><!-- row -->

      

     
 
 
 

        <div class="row row-sm mg-t-20">
 
          <div class="col-lg-12 mg-t-20 mg-lg-t-0">
            <div class="card shadow-base bd-0">
              <div class="card-header pd-20 bg-transparent">
                <h4 class="card-title tx-uppercase tx-25 mg-b-0">الدفعات</h4>
              </div><!-- card-header -->
              <table class="table table-responsive w-100 mg-b-0 tx-12" id="apartmentsTable">
                <thead>
                  <tr class="tx-10">
                    <th class="pd-y-5">قيمة الدفعة</th>
                    <th class="pd-y-5 tx-right">تاريخ الدفعة</th>
                    <th class="pd-y-5">عن شهر</th>
                    <th class="pd-y-5">نوع الدفعة  </th>
                    <th class="pd-y-5">رقم الشيك ان وجد</th>
                    <th class="pd-y-5">تاريخ استحقاق الشيك ان وجد </th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
              <div class="card-footer tx-12 pd-y-15 bg-transparent">
                <a data-toggle="collapse" href="#collapseExample"  aria-expanded="false" aria-controls="collapseExample"class="tx-15 tx-warning tx-bold"><i class="fa fa-edit mg-r-5 tx-danger"></i>  أضافة دفعة جديدة </a>
              </div><!-- card-footer -->
              <div class="collapse" id="collapseExample">
                <div class="card card-body">
                  <form class="form-layout form-layout-1" id="paymentForm" enctype="multipart/form-data">
                    <div class="row mg-b-25">
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label">  قيمة الدفعة: <span class="tx-danger">*</span></label>
                          <input class="form-control" type="number" id="paymentValue" name="paymentValue" required>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label"> الشهر: <span class="tx-danger">*</span></label>
                          <select class="custom-select" id="month" name="month"required>
                            <option selected value="">اختر...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label"> طريقة الدفع: <span class="tx-danger">*</span></label>
                          <select class="custom-select" onchange="checkPaymentType()" id="paymentType" name="paymentType"required>
                            <option selected value="">اختر...</option>
                            <option value="CASH">Cash</option>
                            <option value="CHEQUE">Cheque</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label"> الملاحظات : </label>
                          <input class="form-control" type="text" id="notes" name="notes">
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label"> العملة: <span class="tx-danger">*</span></label>
                          <select class="custom-select" id="currency" name="currency"required>
                            <option selected value="">اختر...</option>
                            <option value="NIS">شيكل</option>
                            <option value="JOD">دينار اردني</option>
                            <option value="USD">دولار امريكي</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label" id="labelchequeNumber"> رقم الشيك : </label>
                          <input class="form-control" type="number" id="chequeNumber" name="chequeNumber">
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class="form-control-label" id="labelchequeDueDate"> تاريخ الشيك : </label>
                          <input class="form-control" type="date" id="chequeDueDate" name="chequeDueDate">
                        </div>
                      </div>

                    </div>
                    <div class="form-layout-footer">
                      <button class="btn btn-success" type="submit">انشاء</button>
                    </div>
                  </form>
                </div>
              </div>
            </div><!-- card -->
          </div><!-- col-6 -->
        </div><!-- row -->

       
      </div><!-- br-pagebody -->

      <footer class="br-footer">
 
      </footer>
    </div><!-- br-mainpanel -->
    <!-- ########## END: MAIN PANEL ########## -->

    <script src="lib/jquery/jquery.min.js"></script>
    <script src="lib/jquery-ui/ui/widgets/datepicker.js"></script>
    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="lib/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="lib/moment/min/moment.min.js"></script>
    <script src="lib/peity/jquery.peity.min.js"></script>
    <script src="lib/jquery-sparkline/jquery.sparkline.min.js"></script>
    <script src="lib/rickshaw/vendor/d3.min.js"></script>
    <script src="lib/rickshaw/vendor/d3.layout.min.js"></script>
    <script src="lib/rickshaw/rickshaw.min.js"></script>

    <script src="js/bracket.js"></script>
    <script src="js/ResizeSensor.js"></script>
    <script src="js/widgets.js"></script>
    <script>
      function checkPaymentType(){
        var paymentType = document.getElementById("paymentType").value;
        if (paymentType === "CASH") {
          document.getElementById("chequeNumber").style.display = "none";
          document.getElementById("chequeDueDate").style.display = "none";
          document.getElementById("labelchequeNumber").style.display = "none";
          document.getElementById("labelchequeDueDate").style.display = "none";
        }else {
          document.getElementById("chequeNumber").style.display = "block";
          document.getElementById("chequeDueDate").style.display = "block";
          document.getElementById("labelchequeNumber").style.display = "block";
          document.getElementById("labelchequeDueDate").style.display = "block";
        }
      }
      $(function(){
        'use strict'
        $(window).resize(function(){
          minimizeMenu();
        });

        minimizeMenu();

        function minimizeMenu() {
          if(window.matchMedia('(min-width: 992px)').matches && window.matchMedia('(max-width: 1199px)').matches) {
            // show only the icons and hide left menu label by default
            $('.menu-item-label,.menu-item-arrow').addClass('op-lg-0-force d-lg-none');
            $('body').addClass('collapsed-menu');
            $('.show-sub + .br-menu-sub').slideUp();
          } else if(window.matchMedia('(min-width: 1200px)').matches && !$('body').hasClass('collapsed-menu')) {
            $('.menu-item-label,.menu-item-arrow').removeClass('op-lg-0-force d-lg-none');
            $('body').removeClass('collapsed-menu');
            $('.show-sub + .br-menu-sub').slideDown();
          }
        }
      });
      // Step 1: Get the apartment ID from the URL
      const urlParams = new URLSearchParams(window.location.search);
      const apartmentId = urlParams.get('id');
      console.log("Apartment Id is :- "+ apartmentId);
      // Step 2: Fetch building details
      if (apartmentId) {
        fetchApartmentDetails(apartmentId);
        fetchPayments(apartmentId);
      } else {
        console.error('No Apartment ID provided in URL');
      }

      function fetchApartmentDetails(id) {
        const apiUrl = `https://apartman-service-production.up.railway.app/apartments/${id}`;
        
        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJraGFsZWQuYXNmdXJAZ21haWwuY29tIiwiaWF0IjoxNzMwODU0ODEyLCJleHAiOjE3MzM0NDY4MTJ9.uHj37pf2zyxfJXv6BgE-M-Gva5HwOqu6TpWSd32sKWw'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
            document.getElementById('Aname').textContent ="شقة "+ data.name;
            document.getElementById('Adescription').textContent = data.description;
            document.getElementById('AroomsCount').textContent = data.numberOfRooms;
            document.getElementById('AisAvaliable').textContent = data.available ? 'نعم' : 'لا';
            document.getElementById('ArentingValuePerMonth').textContent = data.monthlyRentValue;
            console.log(data.name);
            console.log(data.monthlyRentPrice);
        })
        .catch(error => {
          console.error('Error fetching building details:', error);
        });
      }

      function fetchPayments(apartmentId) {
      console.log("Payments API");
      const apiUrl = `https://apartman-service-production.up.railway.app/payments/apartment-payments/${apartmentId}`;

      fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJraGFsZWQuYXNmdXJAZ21haWwuY29tIiwiaWF0IjoxNzMwODU0ODEyLCJleHAiOjE3MzM0NDY4MTJ9.uHj37pf2zyxfJXv6BgE-M-Gva5HwOqu6TpWSd32sKWw'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(payments => {
        const paymentsTableBody = document.querySelector('#apartmentsTable tbody');
        paymentsTableBody.innerHTML = ''; // Clear any existing rows

        payments.forEach(payment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="tx-success">${payment.value}</td>
            <td>${payment.paymentDate.split('T')[0]}</td>
            <td>${payment.month}</td>
            <td class="tx-warning">${payment.paymentType}</td>
            <td>${payment.chequeNumber ? payment.chequeNumber : '-'}</td>
            <td class="tx-danger">${payment.chequeDueDate ? payment.chequeDueDate.split('T')[0] : '-'}</td>
            `;
            paymentsTableBody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error fetching payments:', error);
      });
    }

    document.getElementById('paymentForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent default form submission

      // Collect form data
      const paymentData = {
        value: document.getElementById('paymentValue').value,
        month: document.getElementById('month').value,
        paymentType: document.getElementById('paymentType').value,
        notes: document.getElementById('notes').value,
        currency: document.getElementById('currency').value,
        apartmentId: apartmentId,
        paymentDate: getCurrentISODate(),
        tenantId: 1,
        chequeNumber: document.getElementById('chequeNumber').value || null,
        chequeDueDate: formatToISO(document.getElementById('chequeDueDate').value) || null,

      };

      // API URL and Bearer token
      const apiUrl = "https://apartman-service-production.up.railway.app/payments";
      const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJraGFsZWQuYXNmdXJAZ21haWwuY29tIiwiaWF0IjoxNzMwODU0ODEyLCJleHAiOjE3MzM0NDY4MTJ9.uHj37pf2zyxfJXv6BgE-M-Gva5HwOqu6TpWSd32sKWw";

      // Send POST request to create payment
      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(paymentData)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Payment created successfully:', data);
        alert('تم انشاء الدفعة بنجاح !!');
        // Optionally reset the form or redirect the user
        document.getElementById('paymentForm').reset();
        fetchPayments(apartmentId);
      })
      .catch(error => {
        console.error('There was an error creating the payment!', error);
        alert('Failed to create payment. Please try again.');
      });
    });
    function formatToISO(dateString) {
      if (!dateString) return null; // Return null if dateString is empty
      const date = new Date(dateString);
      return isNaN(date.getTime()) ? null : date.toISOString(); // Ensure valid date
    }
    function getCurrentISODate() {
      return new Date().toISOString();
    }
    </script>
  </body>
</html>
